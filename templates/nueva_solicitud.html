{% extends "base.html" %}

{% block title %}Nueva Solicitud - Sistema de Vacaciones{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/solicitudes" class="back-link">‚Üê Volver a solicitudes</a>
    <h1>üìù Nueva Solicitud de Vacaciones</h1>
</div>

<div class="form-layout">

    <!-- Formulario principal -->
    <div class="detalle-section">   <!-- reutiliza el mismo card blanco que empleado_detalle -->
        <h2>Datos de la solicitud</h2>

        <form id="form-solicitud" onsubmit="enviarSolicitud(event)">

            <!-- Seleccionar empleado -->
            <div class="form-group">
                <label for="empleado_id" class="form-label">Empleado</label>
                <select id="empleado_id" name="empleado_id" class="form-input" required
                        onchange="actualizarPreview()">
                    <option value="" disabled selected>‚Äî Selecciona un empleado ‚Äî</option>
                    {% for emp in empleados %}
                    <option value="{{ emp.id }}"
                            {% if empleado_preseleccionado.as_deref() == Some(&emp.id) %}selected{% endif %}>
                        {{ emp.nombre }} ¬∑ {{ emp.departamento }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Fechas lado a lado (reutiliza detalle-grid en mobile ‚Üí 1 col) -->
            <div class="detalle-grid">
                <div class="form-group">
                    <label for="fecha_inicio" class="form-label">üìÖ Fecha de inicio</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" class="form-input" required
                           onchange="actualizarPreview()">
                </div>
                <div class="form-group">
                    <label for="fecha_fin" class="form-label">üìÖ Fecha de fin</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" class="form-input" required
                           onchange="actualizarPreview()">
                </div>
            </div>

            <!-- Resumen en tiempo real (reutiliza empleado-stats) -->
            <div class="empleado-stats" id="preview-stats">
                <div class="stat">
                    <span class="stat-label">D√≠as solicitados</span>
                    <span class="stat-value" id="preview-solicitados">‚Äî</span>
                </div>
                <div class="stat">
                    <span class="stat-label">D√≠as disponibles</span>
                    <span class="stat-value stat-highlight" id="preview-disponibles">‚Äî</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Quedar√°n</span>
                    <span class="stat-value" id="preview-restantes">‚Äî</span>
                </div>
            </div>

            <!-- Alerta de error (oculta por defecto) -->
            <div class="form-error" id="form-error" style="display:none;">
                <span id="error-msg"></span>
            </div>

            <!-- Botones -->
            <div class="actions-bar">   <!-- reutiliza acciones-bar de empleado_detalle -->
                <button type="submit" class="btn btn-large">Enviar solicitud</button>
                <a href="/solicitudes"   class="btn btn-secondary btn-large">Cancelar</a>
            </div>
        </form>
    </div>

    <!-- Sidebar informativa -->
    <div class="form-sidebar">
        <div class="info-box">
            <h3>‚ÑπÔ∏è Informaci√≥n importante</h3>
            <ul>
                <li>Los d√≠as incluyen la fecha de inicio y de fin.</li>
                <li>La solicitud debe ser aprobada por un administrador.</li>
                <li>No puedes solicitar m√°s d√≠as de los que tienes disponibles.</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>üìä D√≠as seg√∫n antig√ºedad</h3>
            <ul>
                <li>1er a√±o ‚Üí 12 d√≠as</li>
                <li>2do a√±o ‚Üí 14 d√≠as</li>
                <li>3er a√±o ‚Üí 16 d√≠as</li>
                <li>4to a√±o ‚Üí 18 d√≠as</li>
                <li>5to a√±o ‚Üí 20 d√≠as</li>
                <li>6to a√±o+ ‚Üí +2 cada 5 a√±os</li>
            </ul>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ JS ‚îÄ‚îÄ‚îÄ -->
<script>
// Mapa empleado_id ‚Üí { diasDisponibles }  generado desde el handler
const empleados = {
{% for emp in empleados %}
    "{{ emp.id }}": { diasDisponibles: {{ emp.dias_disponibles.unwrap_or(0) }}, nombre: "{{ emp.nombre }}" },
{% endfor %}
};

 /* calcula d√≠as laborables entre dos strings YYYY-MM-DD (inclusive, excluyendo s√°bados y domingos) */                                    
  function calcDias(inicio, fin) {                                                                                                         
      if (!inicio || !fin) return null;                                                                                                    
                                                                                                                                           
      const fechaInicio = new Date(inicio + 'T12:00:00');                                                                                  
      const fechaFin = new Date(fin + 'T12:00:00');                                                                                        
                                                                                                                                           
      if (fechaFin < fechaInicio) return null;                                                                                             
                                                                                                                                           
      let diasLaborables = 0;                                                                                                              
      let fechaActual = new Date(fechaInicio);                                                                                             
                                                                                                                                           
      while (fechaActual <= fechaFin) {                                                                                                    
          const diaSemana = fechaActual.getDay(); // 0=Domingo, 1=Lunes, ..., 6=S√°bado                                                     
                                                                                                                                           
          if (diaSemana !== 0 && diaSemana !== 6) {  // Excluir Domingo (0) y S√°bado (6)                                                   
              diasLaborables++;                                                                                                            
          }                                                                                                                                
                                                                                                                                           
          fechaActual.setDate(fechaActual.getDate() + 1);                                                                                  
      }                                                                                                                                    
                                                                                                                                           
      return diasLaborables;                                                                                                               
  } 

function actualizarPreview() {
    const empId     = document.getElementById('empleado_id').value;
    const inicio    = document.getElementById('fecha_inicio').value;
    const fin       = document.getElementById('fecha_fin').value;
    const emp       = empleados[empId];
    const solicitados = calcDias(inicio, fin);

    // ‚îÄ‚îÄ d√≠as solicitados ‚îÄ‚îÄ
    document.getElementById('preview-solicitados').textContent = solicitados ?? '‚Äî';

    // ‚îÄ‚îÄ disponibles y restantes ‚îÄ‚îÄ
    if (emp) {
        document.getElementById('preview-disponibles').textContent = emp.diasDisponibles;

        if (solicitados !== null) {
            const rest = emp.diasDisponibles - solicitados;
            const el   = document.getElementById('preview-restantes');
            el.textContent = rest;
            el.className   = 'stat-value ' + (rest >= 0 ? 'stat-highlight' : 'stat-danger');
        } else {
            document.getElementById('preview-restantes').textContent = '‚Äî';
        }
    } else {
        document.getElementById('preview-disponibles').textContent = '‚Äî';
        document.getElementById('preview-restantes').textContent   = '‚Äî';
    }
}

/* valida min de fecha_fin cuando cambia fecha_inicio */
document.getElementById('fecha_inicio').addEventListener('change', function () {
    document.getElementById('fecha_fin').setAttribute('min', this.value);
    actualizarPreview();
});

/* env√≠a POST al endpoint JSON y redirige */
async function enviarSolicitud(e) {
    e.preventDefault();

    const empleadoId  = document.getElementById('empleado_id').value;
    const fechaInicio = document.getElementById('fecha_inicio').value;
    const fechaFin    = document.getElementById('fecha_fin').value;
    const emp         = empleados[empleadoId];
    const dias        = calcDias(fechaInicio, fechaFin);

    // validaci√≥n client-side
    if (emp && dias !== null && dias > emp.diasDisponibles) {
        mostrarError(`No hay suficientes d√≠as disponibles (disponibles: ${emp.diasDisponibles}, solicitados: ${dias}).`);
        return;
    }

    console.log('Empleado:',  emp );
    const res = await fetch('/api/solicitudes', {
        method:  'POST',
        headers: { 'Content-Type': 'application/json' },
        body:    JSON.stringify({ empleado_id: empleadoId, empleado_nombre: emp?.nombre || '', fecha_inicio: fechaInicio, fecha_fin: fechaFin }),
    });

    if (res.ok) {
        window.location.href = '/solicitudes';   // redirigir al listado
    } else {
        const err = await res.json().catch(() => ({ error: 'Error desconocido' }));
        mostrarError(err.error);
    }
}

function mostrarError(msg) {
    document.getElementById('error-msg').textContent = msg;
    document.getElementById('form-error').style.display = 'block';
}

// ‚îÄ‚îÄ inicializaci√≥n ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', () => {
    // fecha m√≠nima = hoy
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_inicio').setAttribute('min', hoy);
    document.getElementById('fecha_fin').setAttribute('min', hoy);

    // preseleccionar empleado si viene por query param (desde empleado_detalle)
    const params = new URLSearchParams(location.search);
    const empParam = params.get('empleado_id');
    if (empParam) document.getElementById('empleado_id').value = empParam;

    actualizarPreview();
});
</script>
{% endblock %}